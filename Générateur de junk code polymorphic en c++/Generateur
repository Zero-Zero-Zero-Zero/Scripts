#include <iostream>
#include <fstream>
#include <vector>
#include <random>
#include <chrono>
#include <string>
#include <sstream>

class PowerShellJunkGenerator {
private:
    std::mt19937 rng;
    std::vector<std::string> junkInstructions = {
        "$null | Out-Null",
        "$_ = $_",
        "if ($true) { }",
        "try { } catch { }",
        "[void]($null -eq $null)",
        "$ErrorActionPreference = $ErrorActionPreference",
        "function Noop { param($x) $x }; Noop 1",
        "$PSVersionTable.PSVersion | Out-Null"
    };

public:
    PowerShellJunkGenerator() : rng(std::chrono::steady_clock::now().time_since_epoch().count()) {}

    std::string generateJunkCode(int numInstructions) {
        std::string junkCode;
        std::uniform_int_distribution<int> dist(0, junkInstructions.size() - 1);

        for (int i = 0; i < numInstructions; ++i) {
            junkCode += junkInstructions[dist(rng)] + "\n";
        }

        return junkCode;
    }

    std::string injectJunkCode(const std::string& script) {
        std::istringstream iss(script);
        std::string line;
        std::string modifiedScript;
        std::uniform_int_distribution<int> dist(1, 3);

        while (std::getline(iss, line)) {
            modifiedScript += line + "\n";
            if (!line.empty() && line[0] != '#') {
                modifiedScript += generateJunkCode(dist(rng));
            }
        }

        return modifiedScript;
    }
};

int main(int argc, char* argv[]) {
    if (argc != 3) {
        std::cerr << "Usage: " << argv[0] << " <input_powershell_script> <output_powershell_script>" << std::endl;
        return 1;
    }

    std::string inputFile = argv[1];
    std::string outputFile = argv[2];

    std::ifstream inFile(inputFile);
    if (!inFile) {
        std::cerr << "Error: Cannot open input file." << std::endl;
        return 1;
    }

    std::string script((std::istreambuf_iterator<char>(inFile)), std::istreambuf_iterator<char>());
    inFile.close();

    PowerShellJunkGenerator generator;
    std::string modifiedScript = generator.injectJunkCode(script);

    std::ofstream outFile(outputFile);
    if (!outFile) {
        std::cerr << "Error: Cannot open output file." << std::endl;
        return 1;
    }

    outFile << modifiedScript;
    outFile.close();

    std::cout << "Junk code injected successfully. Modified script saved to " << outputFile << std::endl;

    return 0;
}
